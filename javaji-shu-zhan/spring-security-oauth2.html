<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Spring Security OAuth2 | PYY在线笔记</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/study/img/logo.png">
    <meta name="description" content="PYY在线笔记">
    
    <link rel="preload" href="/study/assets/css/0.styles.f503b9f0.css" as="style"><link rel="preload" href="/study/assets/js/app.dc60e210.js" as="script"><link rel="preload" href="/study/assets/js/6.fceef279.js" as="script"><link rel="preload" href="/study/assets/js/14.48e59348.js" as="script"><link rel="prefetch" href="/study/assets/js/10.7ed69d34.js"><link rel="prefetch" href="/study/assets/js/11.9448c32e.js"><link rel="prefetch" href="/study/assets/js/12.86c493c7.js"><link rel="prefetch" href="/study/assets/js/13.9ed58975.js"><link rel="prefetch" href="/study/assets/js/15.b5bdf29c.js"><link rel="prefetch" href="/study/assets/js/16.7e65e129.js"><link rel="prefetch" href="/study/assets/js/17.d21d2357.js"><link rel="prefetch" href="/study/assets/js/18.ff6a09ec.js"><link rel="prefetch" href="/study/assets/js/19.4dd597a5.js"><link rel="prefetch" href="/study/assets/js/2.6082ecbd.js"><link rel="prefetch" href="/study/assets/js/20.13424f64.js"><link rel="prefetch" href="/study/assets/js/21.d0a93e41.js"><link rel="prefetch" href="/study/assets/js/22.3157d1d1.js"><link rel="prefetch" href="/study/assets/js/23.bf30424e.js"><link rel="prefetch" href="/study/assets/js/24.6e0cd257.js"><link rel="prefetch" href="/study/assets/js/25.85fbb512.js"><link rel="prefetch" href="/study/assets/js/26.c54e0c14.js"><link rel="prefetch" href="/study/assets/js/27.6da488a3.js"><link rel="prefetch" href="/study/assets/js/28.321038ce.js"><link rel="prefetch" href="/study/assets/js/29.3fe454c4.js"><link rel="prefetch" href="/study/assets/js/3.e7c144f8.js"><link rel="prefetch" href="/study/assets/js/30.2c2ed4ad.js"><link rel="prefetch" href="/study/assets/js/31.99fb9619.js"><link rel="prefetch" href="/study/assets/js/32.5aea4bba.js"><link rel="prefetch" href="/study/assets/js/33.8ed67f2e.js"><link rel="prefetch" href="/study/assets/js/34.4eb2a764.js"><link rel="prefetch" href="/study/assets/js/35.32c83c52.js"><link rel="prefetch" href="/study/assets/js/36.0e7c4410.js"><link rel="prefetch" href="/study/assets/js/37.029a3bab.js"><link rel="prefetch" href="/study/assets/js/38.9404c1e2.js"><link rel="prefetch" href="/study/assets/js/39.99a331b6.js"><link rel="prefetch" href="/study/assets/js/4.5e539c6c.js"><link rel="prefetch" href="/study/assets/js/40.68a12f82.js"><link rel="prefetch" href="/study/assets/js/41.f802eb8f.js"><link rel="prefetch" href="/study/assets/js/42.9353144d.js"><link rel="prefetch" href="/study/assets/js/43.58a525e4.js"><link rel="prefetch" href="/study/assets/js/44.d327c357.js"><link rel="prefetch" href="/study/assets/js/45.54dc5bdd.js"><link rel="prefetch" href="/study/assets/js/46.97eb4353.js"><link rel="prefetch" href="/study/assets/js/47.d0f5dd26.js"><link rel="prefetch" href="/study/assets/js/48.c71e0efd.js"><link rel="prefetch" href="/study/assets/js/49.c4bf96d9.js"><link rel="prefetch" href="/study/assets/js/5.49f21cfc.js"><link rel="prefetch" href="/study/assets/js/50.a9f40bc0.js"><link rel="prefetch" href="/study/assets/js/51.cb5601bb.js"><link rel="prefetch" href="/study/assets/js/52.f4b73d57.js"><link rel="prefetch" href="/study/assets/js/7.e9fa99bf.js"><link rel="prefetch" href="/study/assets/js/8.60f08f23.js"><link rel="prefetch" href="/study/assets/js/9.1ebd5ad9.js">
    <link rel="stylesheet" href="/study/assets/css/0.styles.f503b9f0.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/study/" class="home-link router-link-active"><img src="/study/img/logo.png" alt="PYY在线笔记" class="logo"> <span class="site-name can-hide">PYY在线笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/study/技术方案/" class="nav-link">
  技术方案
</a></div><div class="nav-item"><a href="/study/Java技术栈/" class="nav-link">
  Java技术栈
</a></div><div class="nav-item"><a href="/study/分布式/" class="nav-link">
  分布式
</a></div><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/study/消息队列/" class="nav-link">
  消息队列
</a></div><div class="nav-item"><a href="/study/数据结构和算法/" class="nav-link">
  数据结构和算法
</a></div><div class="nav-item"><a href="/study/k8s/" class="nav-link">
  k8s
</a></div><div class="nav-item"><a href="/study/ServiceMesh/" class="nav-link">
  ServiceMesh
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/study/总结/" class="nav-link">
  总结
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/study/技术方案/" class="nav-link">
  技术方案
</a></div><div class="nav-item"><a href="/study/Java技术栈/" class="nav-link">
  Java技术栈
</a></div><div class="nav-item"><a href="/study/分布式/" class="nav-link">
  分布式
</a></div><div class="nav-item"><a href="/study/大数据/" class="nav-link">
  大数据
</a></div><div class="nav-item"><a href="/study/消息队列/" class="nav-link">
  消息队列
</a></div><div class="nav-item"><a href="/study/数据结构和算法/" class="nav-link">
  数据结构和算法
</a></div><div class="nav-item"><a href="/study/k8s/" class="nav-link">
  k8s
</a></div><div class="nav-item"><a href="/study/ServiceMesh/" class="nav-link">
  ServiceMesh
</a></div><div class="nav-item"><a href="/study/DevOps/" class="nav-link">
  DevOps
</a></div><div class="nav-item"><a href="/study/总结/" class="nav-link">
  总结
</a></div><div class="nav-item"><a href="https://www.jianshu.com/u/af08f637aff8" target="_blank" rel="noopener noreferrer" class="nav-link external">
  博客
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dev Ops</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Java技术栈</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/study/javaji-shu-zhan/" aria-current="page" class="sidebar-link">介绍</a></li><li><a href="/study/javaji-shu-zhan/spring.html" class="sidebar-link">Spring注解开发</a></li><li><a href="/study/javaji-shu-zhan/spring-boot.html" class="sidebar-link">SpringBoot 基础篇</a></li><li><a href="/study/javaji-shu-zhan/spring-security-oauth2.html" aria-current="page" class="active sidebar-link">Spring Security OAuth2</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#用户认证需求分析" class="sidebar-link">用户认证需求分析</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#用户认证与授权需求" class="sidebar-link">用户认证与授权需求</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#单点登录需求" class="sidebar-link">单点登录需求</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#第三方认证需求" class="sidebar-link">第三方认证需求</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#什么是-oauth2-0" class="sidebar-link">什么是 OAuth2.0</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#什么是-spring-security" class="sidebar-link">什么是 Spring Security</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#为什么需要-oauth2-0" class="sidebar-link">为什么需要 OAuth2.0</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#应用场景" class="sidebar-link">应用场景</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#名词解释" class="sidebar-link">名词解释</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#交互过程" class="sidebar-link">交互过程</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#开发平台" class="sidebar-link">开发平台</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#交互模型" class="sidebar-link">交互模型</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#认证服务器" class="sidebar-link">认证服务器</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#oauth2-开放平台" class="sidebar-link">oAuth2 开放平台</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#令牌的访问与刷新" class="sidebar-link">令牌的访问与刷新</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#access-token" class="sidebar-link">Access Token</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#refresh-token" class="sidebar-link">Refresh Token</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#客户端授权模式" class="sidebar-link">客户端授权模式</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#简化模式" class="sidebar-link">简化模式</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#授权码模式" class="sidebar-link">授权码模式</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#密码模式" class="sidebar-link">密码模式</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#客户端模式" class="sidebar-link">客户端模式</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#创建案例工程" class="sidebar-link">创建案例工程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#创建-spring-security-oauth2-工程" class="sidebar-link">创建 spring-security-oauth2 工程</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#创建spring-security-oauth2-dependencies" class="sidebar-link">创建spring-security-oauth2-dependencies</a></li></ul></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#创建认证服务器" class="sidebar-link">创建认证服务器</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#创建认证服务器模板" class="sidebar-link">创建认证服务器模板</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#基于内存存储令牌" class="sidebar-link">基于内存存储令牌</a></li><li class="sidebar-sub-header"><a href="/study/javaji-shu-zhan/spring-security-oauth2.html#基于-jdbc-存储令牌" class="sidebar-link">基于 JDBC 存储令牌</a></li></ul></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Service Mesh</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>K 8 S</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>分布式</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>大数据</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>总结</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>技术方案</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>数据结构和算法</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>消息队列</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="spring-security-oauth2"><a href="#spring-security-oauth2" class="header-anchor">#</a> Spring Security OAuth2</h1> <h2 id="用户认证需求分析"><a href="#用户认证需求分析" class="header-anchor">#</a> 用户认证需求分析</h2> <h3 id="用户认证与授权需求"><a href="#用户认证与授权需求" class="header-anchor">#</a> 用户认证与授权需求</h3> <p><strong>什么是用户身份认证？</strong></p> <p>用户身份认证即用户去访问系统资源时，系统要求验证用户的身份信息，身份合法方可继续访问。</p> <p>常见的有用户身份认证表现形式有：用户名密码登录，指纹、人脸识别等。</p> <p><strong>什么是用户授权？</strong></p> <p>用户认证通过后去访问系统资源，系统会判断用户是否拥有访问资源的权限，只允许访问有权限的系统资源，没有权限的系统资源将无法访问，这个过程叫用户授权。</p> <h3 id="单点登录需求"><a href="#单点登录需求" class="header-anchor">#</a> 单点登录需求</h3> <p>单点登录（Single Sign On），简称为 SSO，是比较流行的企业业务整合的解决方案之一。SSO的定义是在多个<a href="https://baike.baidu.com/item/%E5%BA%94%E7%94%A8/3994271" target="_blank" rel="noopener noreferrer">应用<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>系统中，用户只需要登录一次就可以访问所有相互信任的应用系统。</p> <p><img src="/study/assets/img/image-20210803183124509.449bdd19.png" alt="image-20210803183124509"></p> <h3 id="第三方认证需求"><a href="#第三方认证需求" class="header-anchor">#</a> 第三方认证需求</h3> <p>一个微信用户没有注册某学习网站注册，但某学习网站系统可以通过微信系统来验证该用户的身份，验证通过后该用户就可以进行系统学习，基本流程如下：</p> <p><img src="/study/assets/img/image-20210803183559047.99b1039f.png" alt="image-20210803183559047"></p> <p>从上图可以看出，微信不属于某学习系统，某学习系统也没有存储微信用户的账号，密码登录信息。如果要获取该用户的基本信息则需要通过微信的认证系统（微信认证）进行认证，微信认证通过后，系统便可获取该微信用户的基本信息（用户头像、昵称等），该用户便可不注册直接接入系统。</p> <h2 id="什么是-oauth2-0"><a href="#什么是-oauth2-0" class="header-anchor">#</a> 什么是 OAuth2.0</h2> <p>OAuth（开发授权：Open Authorization）是一个开放标准，允许用户授权第三方应用访问他们存储在另外的服务提供者上的信息，而不需要将用户名和密码提供给第三方应用，即第三方无需使用用户的用户名与密码就可以申请获得该用户资源的授权，因此OAUTH是安全的。</p> <h2 id="什么是-spring-security"><a href="#什么是-spring-security" class="header-anchor">#</a> 什么是 Spring Security</h2> <p>Spring Security 是一个安全框架，前身是 Acegi Security，能够为 Spring 企业应用系统提供声明式的安全访问控制。Spring Security 基于 Servlet 过滤器、IoC 和 AOP，为 Web 请求和方法调用提供身份确认和授权处理，避免了代码耦合，减少了大量重复代码工作。</p> <h2 id="为什么需要-oauth2-0"><a href="#为什么需要-oauth2-0" class="header-anchor">#</a> 为什么需要 OAuth2.0</h2> <h3 id="应用场景"><a href="#应用场景" class="header-anchor">#</a> 应用场景</h3> <p>我们假设你有一个“云笔记”产品，并提供了“云笔记服务”和“云相册服务”，此时用户需要在不同的设备（PC、Android、iPhone、TV、Watch）上去访问这些“资源”（笔记，图片）</p> <p>那么用户如何才能访问属于自己的那部分资源呢？此时传统的做法就是提供自己的账号和密码给我们的“云笔记”，登录成功后就可以获取资源了。但这样的做法会有以下几个问题：</p> <ul><li>“云笔记服务”和“云相册服务”会分别部署，难道我们要分别登录吗？</li> <li>如果有第三方应用程序想要接入我们的“云笔记”，难道需要用户提供账号和密码给第三方应用程序，让他记录后再访问我们的资源吗？</li> <li>用户如何限制第三方应用程序在我们“云笔记”的授权范围和使用期限？难道把所有资料都永久暴露给它吗？</li> <li>如果用户修改了密码收回了权限，那么所有第三方应用程序会全部失效。</li> <li>只要有一个接入的第三方应用程序遭到破解，那么用户的密码就会泄露，后果不堪设想。</li></ul> <p>为了解决如上问题，oAuth 应用而生。</p> <h3 id="名词解释"><a href="#名词解释" class="header-anchor">#</a> 名词解释</h3> <ul><li><strong>第三方应用程序（Third-party application）：</strong> 又称之为客户端（client），比如上节中提到的设备（PC、Android、iPhone、TV、Watch），我们会在这些设备中安装我们自己研发的 APP。又比如我们的产品想要使用 QQ、微信等第三方登录。对我们的产品来说，QQ、微信登录是第三方登录系统。我们又需要第三方登录系统的资源（头像、昵称等）。对于 QQ、微信等系统我们又是第三方应用程序。</li> <li><strong>HTTP 服务提供商（HTTP service）：</strong> 我们的云笔记产品以及 QQ、微信等都可以称之为“服务提供商”。</li> <li><strong>资源所有者（Resource Owner）：</strong> 又称之为用户（user）。</li> <li><strong>用户代理（User Agent）：</strong> 比如浏览器，代替用户去访问这些资源。</li> <li><strong>认证服务器（Authorization server）：</strong> 即服务提供商专门用来处理认证的服务器，简单点说就是登录功能（验证用户的账号密码是否正确以及分配相应的权限）</li> <li><strong>资源服务器（Resource server）：</strong> 即服务提供商存放用户生成的资源的服务器。它与认证服务器，可以是同一台服务器，也可以是不同的服务器。简单点说就是资源的访问入口，比如上节中提到的“云笔记服务”和“云相册服务”都可以称之为资源服务器。</li></ul> <h3 id="交互过程"><a href="#交互过程" class="header-anchor">#</a> 交互过程</h3> <p>oAuth 在 &quot;客户端&quot; 与 &quot;服务提供商&quot; 之间，设置了一个授权层（authorization layer）。&quot;客户端&quot; 不能直接登录 &quot;服务提供商&quot;，只能登录授权层，以此将用户与客户端区分开来。&quot;客户端&quot; 登录授权层所用的令牌（token），与用户的密码不同。用户可以在登录的时候，指定授权层令牌的权限范围和有效期。&quot;客户端&quot; 登录授权层以后，&quot;服务提供商&quot; 根据令牌的权限范围和有效期，向 &quot;客户端&quot; 开放用户储存的资料。</p> <p><img src="/study/assets/img/image-20210731191145857.ebd40113.png" alt="image-20210731191145857"></p> <h2 id="开发平台"><a href="#开发平台" class="header-anchor">#</a> 开发平台</h2> <h3 id="交互模型"><a href="#交互模型" class="header-anchor">#</a> 交互模型</h3> <p>交互模型涉及三方：</p> <ul><li>资源拥有者：用户</li> <li>客户端：APP</li> <li>服务提供方：包含两个角色
<ul><li>认证服务器</li> <li>资源服务器</li></ul></li></ul> <h3 id="认证服务器"><a href="#认证服务器" class="header-anchor">#</a> 认证服务器</h3> <p>认证服务器负责对用户进行认证，并授权给客户端权限。认证很容易实现（验证账号密码即可），问题在于如何授权。比如我们使用第三方登录 &quot;有道云笔记&quot;，你可以看到如使用 QQ 登录的授权页面上有 &quot;有道云笔记将获得以下权限&quot; 的字样以及权限信息</p> <p><img src="/study/assets/img/image-20210731191206301.fb4f8ffa.png" alt="image-20210731191206301"></p> <p>认证服务器需要知道请求授权的客户端的身份以及该客户端请求的权限。我们可以为每一个客户端预先分配一个 id，并给每个 id 对应一个名称以及权限信息。这些信息可以写在认证服务器上的配置文件里。然后，客户端每次打开授权页面的时候，把属于自己的 id 传过来，如：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">http:</span>//www.funtl.com/login?client_id=yourClientId
</code></pre></div><p>随着时间的推移和业务的增长，会发现，修改配置的工作消耗了太多的人力。有没有办法把这个过程自动化起来，把人工从这些繁琐的操作中解放出来？当开始考虑这一步，开放平台的成型也就是水到渠成的事情了。</p> <h3 id="oauth2-开放平台"><a href="#oauth2-开放平台" class="header-anchor">#</a> oAuth2 开放平台</h3> <p>开放平台是由 oAuth2.0 协议衍生出来的一个产品。它的作用是让客户端自己去这上面进行注册、申请，通过之后系统自动分配 <code>client_id</code> ，并完成配置的自动更新（通常是写进数据库）。</p> <p>客户端要完成申请，通常需要填写客户端程序的类型（Web、App 等）、企业介绍、执照、想要获取的权限等等信息。这些信息在得到服务提供方的人工审核通过后，开发平台就会自动分配一个 <code>client_id</code> 给客户端了。</p> <p>到这里，已经实现了登录认证、授权页的信息展示。那么接下来，当用户成功进行授权之后，认证服务器需要把产生的 <code>access_token</code> 发送给客户端，方案如下：</p> <ul><li>让客户端在开放平台申请的时候，填写一个 URL，例如：http://www.funtl.com</li> <li>每次当有用户授权成功之后，认证服务器将页面重定向到这个 URL（回调），并带上 <code>access_token</code>，例如：http://www.funtl.com/login?access_token=123456</li> <li>客户端接收到了这个 <code>access_token</code>，而且认证服务器的授权动作已经完成，刚好可以把程序的控制权转交回客户端，由客户端决定接下来向用户展示什么内容。</li></ul> <h2 id="令牌的访问与刷新"><a href="#令牌的访问与刷新" class="header-anchor">#</a> 令牌的访问与刷新</h2> <h3 id="access-token"><a href="#access-token" class="header-anchor">#</a> Access Token</h3> <p>Access Token 是客户端访问资源服务器的令牌。拥有这个令牌代表着得到用户的授权。然而，这个授权应该是 <strong>临时</strong> 的，有一定有效期。这是因为，Access Token 在使用的过程中 <strong>可能会泄露</strong>。给 Access Token 限定一个 <strong>较短的有效期</strong> 可以降低因 Access Token 泄露而带来的风险。</p> <p>然而引入了有效期之后，客户端使用起来就不那么方便了。每当 Access Token 过期，客户端就必须重新向用户索要授权。这样用户可能每隔几天，甚至每天都需要进行授权操作。这是一件非常影响用户体验的事情。希望有一种方法，可以避免这种情况。</p> <p>于是 oAuth2.0 引入了 Refresh Token 机制</p> <h3 id="refresh-token"><a href="#refresh-token" class="header-anchor">#</a> Refresh Token</h3> <p>Refresh Token 的作用是用来刷新 Access Token。认证服务器提供一个刷新接口，例如：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">http:</span>//www.funtl.com/refresh?refresh_token=&amp;client_id=
</code></pre></div><p>传入 <code>refresh_token</code> 和 <code>client_id</code>，认证服务器验证通过后，返回一个新的 Access Token。为了安全，oAuth2.0 引入了两个措施：</p> <ul><li>oAuth2.0 要求，Refresh Token <strong>一定是保存在客户端的服务器上</strong> ，而绝不能存放在狭义的客户端（例如 App、PC 端软件）上。调用 <code>refresh</code> 接口的时候，一定是从服务器到服务器的访问。</li> <li>oAuth2.0 引入了 <code>client_secret</code> 机制。即每一个 <code>client_id</code> 都对应一个 <code>client_secret</code>。这个 <code>client_secret</code> 会在客户端申请 <code>client_id</code> 时，随 <code>client_id</code> 一起分配给客户端。<strong>客户端必须把 <code>client_secret</code> 妥善保管在服务器上</strong>，决不能泄露。刷新 Access Token 时，需要验证这个 <code>client_secret</code>。</li></ul> <p>实际上的刷新接口类似于：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">http:</span>//localhost:8080/refresh?refresh_token=&amp;client_id=&amp;client_secret=
</code></pre></div><p>以上就是 Refresh Token 机制。Refresh Token 的有效期非常长，会在用户授权时，随 Access Token 一起重定向到回调 URL，传递给客户端。</p> <h2 id="客户端授权模式"><a href="#客户端授权模式" class="header-anchor">#</a> 客户端授权模式</h2> <p>客户端必须得到用户的授权（authorization grant），才能获得令牌（access token）。oAuth 2.0 定义了四种授权方式。</p> <ul><li>implicit：简化模式，不推荐使用</li> <li>authorization code：授权码模式</li> <li>resource owner password credentials：密码模式</li> <li>client credentials：客户端模式</li></ul> <h3 id="简化模式"><a href="#简化模式" class="header-anchor">#</a> 简化模式</h3> <p>简化模式适用于纯静态页面应用。所谓纯静态页面应用，也就是应用没有在服务器上执行代码的权限（通常是把代码托管在别人的服务器上），只有前端 JS 代码的控制权。</p> <p>这种场景下，应用是没有持久化存储的能力的。因此，按照 oAuth2.0 的规定，这种应用是拿不到 Refresh Token 的。其整个授权流程如下：</p> <p><img src="/study/assets/img/image-20210731192939964.91f1e047.png" alt="image-20210731192939964"></p> <p>该模式下，<code>access_token</code> 容易泄露且不可刷新</p> <h3 id="授权码模式"><a href="#授权码模式" class="header-anchor">#</a> 授权码模式</h3> <p>授权码模式适用于有自己的服务器的应用，它是一个一次性的临时凭证，用来换取 <code>access_token</code> 和 <code>refresh_token</code>。认证服务器提供了一个类似这样的接口：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">https:</span>//www.funtl.com/exchange?code=&amp;client_id=&amp;client_secret=
</code></pre></div><p>需要传入 <code>code</code>、<code>client_id</code> 以及 <code>client_secret</code>。验证通过后，返回 <code>access_token</code> 和 <code>refresh_token</code>。一旦换取成功，<code>code</code> 立即作废，不能再使用第二次。流程图如下：</p> <p><img src="/study/assets/img/image-20210731193054989.10dc305f.png" alt="image-20210731193054989"></p> <p>这个 code 的作用是保护 token 的安全性。上一节说到，简单模式下，token 是不安全的。这是因为在第 4 步当中直接把 token 返回给应用。而这一步容易被拦截、窃听。引入了 code 之后，即使攻击者能够窃取到 code，但是由于他无法获得应用保存在服务器的 <code>client_secret</code>，因此也无法通过 code 换取 token。而第 5 步，为什么不容易被拦截、窃听呢？这是因为，首先，这是一个从服务器到服务器的访问，黑客比较难捕捉到；其次，这个请求通常要求是 https 的实现。即使能窃听到数据包也无法解析出内容。</p> <p>有了这个 code，token 的安全性大大提高。因此，oAuth2.0 鼓励使用这种方式进行授权，而简单模式则是在不得已情况下才会使用。</p> <h3 id="密码模式"><a href="#密码模式" class="header-anchor">#</a> 密码模式</h3> <p>密码模式中，用户向客户端提供自己的用户名和密码。客户端使用这些信息，向 &quot;服务商提供商&quot; 索要授权。在这种模式中，用户必须把自己的密码给客户端，但是客户端不得储存密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分。</p> <p>一个典型的例子是同一个企业内部的不同产品要使用本企业的 oAuth2.0 体系。在有些情况下，产品希望能够定制化授权页面。由于是同个企业，不需要向用户展示“xxx将获取以下权限”等字样并询问用户的授权意向，而只需进行用户的身份认证即可。这个时候，由具体的产品团队开发定制化的授权界面，接收用户输入账号密码，并直接传递给鉴权服务器进行授权即可。</p> <p><img src="/study/assets/img/image-20210731193212690.96f0e0ec.png" alt="image-20210731193212690"></p> <p>有一点需要特别注意的是，在第 2 步中，认证服务器需要对客户端的身份进行验证，确保是受信任的客户端。</p> <h3 id="客户端模式"><a href="#客户端模式" class="header-anchor">#</a> 客户端模式</h3> <p>如果信任关系再进一步，或者调用者是一个后端的模块，没有用户界面的时候，可以使用客户端模式。鉴权服务器直接对客户端进行身份验证，验证通过后，返回 token。</p> <p><img src="data:image/png;base64,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AQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SIGDv1HIzWQQQQAABBBBAAIHYBAjYY1sxxosAAggggAACCCDQKQEC9k4tN5NFAAEEEEAAAQQQiE2AgD22FWO8CCCAAAIIIIAAAp0SmOjUbJksAgh0XmB5tS9PHV+S50+9Ky+/uSLHFldl/uwF2bl5Qk6+dT56n52XT8nJpVXZvmmd7J6ekL1XTMkNOzbJLVdvlo0TvejnxwQQQACBLgr0+u4Y14n3vvaw9B+6c1ynx7wQQKCAwJFX3pYjry7KL04vi0y4f1w8f+GD2roLjlMsG85nys139YLMbN0g+/dskTvcHw4EEEAAgXgEeIc9nrVipAggUELg8EuLcnBu4WKQvvJ+kO4H69rmOAXrSfN5f75zp8/J3BtvyFefOSOzM1vlwL7pEqJUQQABBBBoWoBn2JsWpz8EEGhE4Ilj70hv9oQcfOE3IvqOswXrjfTe4k7UwXmoS+/wr+TJ15ZaPFiGhgACCCCgAgTs/D1AAIGxE7jrp2fkC8+eEVl2wWn4bvrYzbbkhNTl7Hty2zMLol4cCCCAAALtFeCRmPauDSNDAIESAp99dF5eeNN9eHRF31bnyBRwH7idfW1RXnrjnLx4+/bM4hRAAAEEEGhegHfYmzenRwQQqEmg9+AJeWGBYL0wr/ufm6POTf04EEAAAQTaJ0DA3r41YUQIIFBCYC3Y1Mc8xveLr0qoFKiibs6PoL2AGUURQACBhgQI2BuCphsEEKhP4Hr3GAyPwFTk695tv/7RUxU1RjMIIIAAAlUIELBXoUgbCCAwMgH9wORRfWadd9arWQPneNT9oNTdT7tv1+FAAAEEEGiFAAF7K5aBQSCAQBkB/UrC2ZPv8O56GbxBddy77D96fVH0qzE5EEAAAQRGL0DAPvo1YAQIIFBS4LafuR9EWnLPrXNUL+C+PeYLz/Iue/WwtIgAAggUFyBgL25GDQQQaIGA/oKpEKvXuxLvXZA153p7oXUEEEAAgQwBAvYMILKbEeh9+f6PdJSU5hfKyvfL2nVYJ7y3cnb28/V60B+rw7kZgYNz7t11fhSpXuzzfVlzrrcXWkcAAQQQyBDo9d2RUSba7N7XHpb+Q3dGO/6uDVyD4f5j931o2klpfgE/X6+TjkFt5qljfdjZ+gjvLZ1z/QJHXnlbvvrcG+7Zdd5ir117cp38+Mbfkzv2bKm9KzpAAAEEEEgW4JdOk11ILSngB8BhoJzVpJX329A6/r2Vsbb8e//a8v26lmblNC/t2srq2cr4aX5dP53rZgQecQE7wXoz1ur8yKuLBOwNcdMNAgggkCRAwJ6kQlopgTCIDe/zNmoBclb9rPy0/qxe2E+YPqi+5ml5O6wtu+dcn8Dyal/mFs4N1UH/m1dL74fHL7UR3l/KeP/Cz9frQYff7qByWXl+n3nK+mV0DOE4hxnX3Ollv3muEUAAAQQaFiBgbxic7j4qUEXg67ehPSQF0FbG8sJ7TQ/T9N7K+yP306yOn891fQJPHV8SmXAfvxni+XULaP0gNgxwdQaWH5a3dC0zKLAO27R2tJ5/+O1putWz86Cylmdt+HWS0qx8obN6cyCAAAIIjEyAgH1k9OPXsR/EJs0uK/hNCnzDtEF9WF5Yx8Zi+Wn3mp5UJmncaX1Y25zrE3j+1NmhgnUbmR/Mpl1bWT1bGT9Ng+OkdL+M5ScF0lrOT7d7rRO2Hd77fVi9PGlhmVz3Q/zPUa72KYQAAgggMFCAgH0gD5llBZKC3DAYztO2X6eKIDlPG36fOsbwPkzL02aeuVLmwwK//t1Z+eI/Pi3f+uI+uWXvpy5lvqy/alrBYQGwH1D7gbKlp3VlgbadtVxWnbS2/HRrw8ZieZZu9/45zLO5aRn/2q/DNQIIIIBAPAIE7PGsVTQjTQrW2zR4PwAPx5o3+M5brk3zjm0sv//xTfKfv/6tfOmh5+TPt31cfnznjfKH7nxscXWoqViAbUFueO8Hyn4Zu/Y799OsHT9fr7PS/TasrtXx85LSrPygs7ahdf22BpUnDwEEEECgfQIE7O1bk6hHFAbAZSZTto2mgmgL+MuOs4xJV+v83Wd2yGO/PCG/OPEb+cx3fyJf/bOrZf7sdhcFO5FeOZUwcA3vtdUwTe+Tgl4LogeNxNoKy1q6X9fKWJ7fp5/mj9Hq+O3odZjutxWWzbwf2y//zZw5BRBAAIFWCIx1wP75P94m+l3sHPUL/MOtfyrf++dnP/T4SJmA1urYOe/ILYjOKu+Xsz70rIfm+fnWlpXLc/+tn7wk33vyl1aUcxUCk+vXvsLx3Ln35PB/vCay4bTIp/YN1XIYzCY1ZgGy5YX3mu6n5WnT2grLWjt2tnJJ57BMeG+BuZ2T2iicVvJ/jgr3QwUEEEAAgUSBsQ7Y//3vb02cNIn1CGjAbsFvUg9h4JtUJilgTio3TJqN0fqyc5iufYRjDu+1jNa39O/+zT7RPxzVCHxl9tm1d9j17fQNG9avvcN++B33Dvs594NJQwaRfqAbBrdhQJ02mzzlkspo39ZnmJ9174/bH5fVs3zrQ8tYml++0DXvsBfiojACCCBQtcBYB+xVY9HeYAELfNNK5c234Nfa0Xs9supbeT1bnaS0tHYs3e8/KS2pfSvn98f18AKP/dcp2bBx6kPPsD/+8EmZb8G3llgQbIF32mz9cmll/HS/vF1bvgXldq9nSwvLap6lDSqj5TKPIf/nKLN9CiCAAAIIDBQgYB/IQ+YoBMLgN7y3MaWla35SXlKateWfk8qFaeG9X5/ragT0W2L+Ytsn5Nt/7b4l5k8++JaY3dMTMv+74T54aoGsjtQCbj+o9fNtNlYu772VSztrH2GbaWUHpVs7Nn4ta2l+vaQ5+flcI4AAAgi0V4CAvb1rw8gQ6LSAfkvM0W9/8SMGe6+YlJ/PD//LmxbgWiBr5zBdBxAG1uG9lrEg2drRtEGHtWFnv2xSmp+fdG39al07ktIsjzMCCCCAQDwCBOzxrBUjRQABJ3DDjo/JA//tfu205GMxFtBaMBuiWrofNCelaT1ry9qwcpZn92E5v22ra+ekPKtv7VlZ/2xlstL8/NzXU/zSaW4rCiKAAAI1CPT67qihXZpEAAEEahFYXu3LpgdfF3GfO+VoSMDF6/1vfPDOfUO90g0CCCCAwPsCvG3CXwUEEIhKYONET2a2bohqzLEPdmbbxtinwPgRQACBqAUI2KNePgaPQDcF9u/ZIjLJ9tXI6jvn/ddON9IVnSCAAAIIJAvwSEyyC6kIINBygd4Dx91zGi0f5DgMz32lY/8eHocZh6VkDgggEK8Ab1HFu3aMHIFOC8zObBXhw5D1/h2Y6smac7290DoCCCCAQIYA77BnAJGNAALtFejNnhBZ5tOnta3QpvXSP3BVbc3TMAIIIIBAPgHeYc/nRCkEEGihwOM3XymyiW2slqVxrk+oLwcCCCCAwMgFeKUb+RIwAAQQKCtw2+7L5OCuy9wHUN2D1hzVCTjPuz49Lbdes7m6NmkJAQQQQKC0AI/ElKajIgIItEXg+kfn5ejCeffpSD6FOvSa9Hpy3dZJefH2HUM3RQMIIIAAAtUIELBX40grCCAwYoHeg+559pK/fjriobere/dB3v7du9o1JkaDAAIIdFyAgL3jfwGYPgLjJLAWtK+4d9l5p734srp31vXRIoL14nTUQAABBOoW4Bn2uoVpHwEEGhPQYPO6rVM8015U3AXq+hgMwXpROMojgAACzQgQsDfjTC8IINCQwIu3b5eD17hf5uTbY/KJO6e7dm/hmfV8WpRCAAEERiLAIzEjYadTBBCoW+DJ15bktmfOiLznHpHh2faPcrsfRZL16+Txz31S9Nt2OBBAAAEE2itAwN7etWFkCCBQgcDhlxbl4NyCyIT7B8UVfmRJJp3D6oW1XzA9sM/9SwQHAggggEDrBQjYW79EDBABBKoQOPLK2/KI+zO3cO5i8O6/667fBjlOX+Uezsd984sG6TPbNsr+a6fljj1bqiClDQQQQACBhgQI2BuCphsEEEAAAQQQQAABBMoI8KHTMmrUQQABBBBAAAEEEECgIQEC9oag6QYBBBBAAAEEEEAAgTICBOxl1KiDAAIIIIAAAggggEBDAgTsDUHTDQIIIIAAAggggAACZQQI2MuoUQcBBBBAAAEEEEAAgYYECNgbgqYbBBBAAAEEEEAAAQTKCBCwl1GjDgIIIIAAAggggAACDQkQsDcETTcIIIAAAggggAACCJQRIGAvo0YdBBBAAAEEEEAAAQQaEiBgbwiabhBAAAEEEEAAAQQQKCNAwF5GjToIIIAAAggggAACCDQkQMDeEDTdIIAAAggggAACCCBQRoCAvYwadRBAAAEEEEAAAQQQaEiAgL0haLpBAAEEEEAAAQQQQKCMAAF7GTXqIIAAAggggAACCCDQkAABe0PQdIMAAggggAACCCCAQBkBAvYyatRBAAEEEEAAAQQQQKAhAQL2hqDpBgEEEEAAAQQQQACBMgIE7GXUqIMAAggggAACCCCAQEMCBOwNQdMNAggggAACCCCAAAJlBAjYy6hRBwEEEEAAAQQQQACBhgQI2BuCphsEEEAAAQQQQAABBMoIELCXUaMOAggggAACCCCAAAINCRCwNwRNNwgggAACCCCAAAIIlBEgYC+jRh0EEEAAAQQQQAABBBoSIGBvCJpuEEAAAQQQQAABBBAoI/D/A8axz1MG9/8AAAAASUVORK5CYII=" alt="image-20210731193254918"></p> <h2 id="创建案例工程"><a href="#创建案例工程" class="header-anchor">#</a> 创建案例工程</h2> <h3 id="创建-spring-security-oauth2-工程"><a href="#创建-spring-security-oauth2-工程" class="header-anchor">#</a> 创建 spring-security-oauth2 工程</h3> <p>聚合工程</p> <p>相关pom依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.example<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>licenses</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>license</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Apache 2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://www.apache.org/licenses/LICENSE-2.0.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>license</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>licenses</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>developers</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>developer</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>pyy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>YangYang Pan<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email</span><span class="token punctuation">&gt;</span></span>https://pyygithub.github.io/study/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>developer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>developers</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.pyy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.spring.javaformat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-javaformat-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.26<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepositories</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepositories</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="创建spring-security-oauth2-dependencies"><a href="#创建spring-security-oauth2-dependencies" class="header-anchor">#</a> 创建spring-security-oauth2-dependencies</h3> <p>用来管理所有相关依赖</p> <p>相关pom依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.pyy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>Greenwich.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>spring-cloud.version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>licenses</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>license</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Apache 2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://www.apache.org/licenses/LICENSE-2.0.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>license</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>licenses</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>developers</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>developer</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>pyy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>YangYang Pan<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email</span><span class="token punctuation">&gt;</span></span>https://pyygithub.github.io/study/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>developer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>developers</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.cloud<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-cloud-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${spring-cloud.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepositories</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepositories</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="创建认证服务器"><a href="#创建认证服务器" class="header-anchor">#</a> 创建认证服务器</h2> <h3 id="创建认证服务器模板"><a href="#创建认证服务器模板" class="header-anchor">#</a> 创建认证服务器模板</h3> <p>新建module： spring-security-oauth2-server</p> <p>相关pom依赖</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token prolog">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project</span> <span class="token attr-name">xmlns</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xmlns:</span>xsi</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://www.w3.org/2001/XMLSchema-instance<span class="token punctuation">&quot;</span></span>
         <span class="token attr-name"><span class="token namespace">xsi:</span>schemaLocation</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modelVersion</span><span class="token punctuation">&gt;</span></span>4.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modelVersion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>parent</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-parent<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>2.1.4.RELEASE<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>relativePath</span><span class="token punctuation">/&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>parent</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.pyy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>1.0-SNAPSHOT<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>packaging</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>packaging</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://pyygithub.github.io/study/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>modules</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>module</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>module</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>modules</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>properties</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>java.version</span><span class="token punctuation">&gt;</span></span>1.8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>java.version</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.source</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>${java.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>maven.compiler.target</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.build.sourceEncoding</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>UTF-8<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project.reporting.outputEncoding</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>properties</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>licenses</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>license</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Apache 2.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://www.apache.org/licenses/LICENSE-2.0.txt<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>license</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>licenses</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>developers</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>developer</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>pyy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>YangYang Pan<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>email</span><span class="token punctuation">&gt;</span></span>https://pyygithub.github.io/study/<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>email</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>developer</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>developers</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependencies</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.pyy<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-dependencies<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${project.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>type</span><span class="token punctuation">&gt;</span></span>pom<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>type</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scope</span><span class="token punctuation">&gt;</span></span>import<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scope</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencies</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependencyManagement</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>build</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugins</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>plugin</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>io.spring.javaformat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-javaformat-maven-plugin<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>0.0.26<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugin</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>plugins</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>build</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repositories</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>repository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repository</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>repositories</span><span class="token punctuation">&gt;</span></span>

    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepositories</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/milestone<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>false<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>id</span><span class="token punctuation">&gt;</span></span>spring-snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>id</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>name</span><span class="token punctuation">&gt;</span></span>Spring Snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>name</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>url</span><span class="token punctuation">&gt;</span></span>https://repo.spring.io/snapshot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>url</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>snapshots</span><span class="token punctuation">&gt;</span></span>
                <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>enabled</span><span class="token punctuation">&gt;</span></span>true<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>enabled</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>snapshots</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepository</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>pluginRepositories</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>project</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>创建Application启动程序</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>pyy<span class="token punctuation">.</span>oauth2</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span></span><span class="token class-name">SpringApplication</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>autoconfigure<span class="token punctuation">.</span></span><span class="token class-name">SpringBootApplication</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * @author panyangyang
 * @date 2021-08-01 16:35
 */</span>
<span class="token annotation punctuation">@SpringBootApplication</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">OAuth2ServerApplication</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">SpringApplication</span><span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">OAuth2ServerApplication</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>整体项目结构如下：</p> <p><img src="/study/assets/img/image-20210801163944191.807dcdb3.png" alt="image-20210801163944191"></p> <h3 id="基于内存存储令牌"><a href="#基于内存存储令牌" class="header-anchor">#</a> 基于内存存储令牌</h3> <h4 id="概述"><a href="#概述" class="header-anchor">#</a> 概述</h4> <p>基于 <strong>内存存储令牌</strong> 的模式用于演示最基本的操作，帮助大家快速理解 oAuth2 认证服务器中 &quot;认证&quot;、&quot;授权&quot;、&quot;访问令牌” 的基本概念</p> <p>操作流程：</p> <p><img src="/study/assets/img/image-20210801164133696.87a44181.png" alt="image-20210801164133696"></p> <ul><li><p>配置客户端信息：</p> <p><strong>ClientDetailsServiceConfigurer</strong>：</p> <ul><li><code>inMemory</code>：内存配置</li> <li><code>withClient</code>：客户端标识</li> <li><code>secret</code>：客户端安全码</li> <li><code>authorizedGrantTypes</code>：客户端授权类型</li> <li><code>scopes</code>：客户端授权范围</li> <li><code>redirectUris</code>：注册回调地址</li></ul></li> <li><p>配置 Web 安全</p></li> <li><p>通过 GET 请求访问认证服务器获取授权码</p> <ul><li>端点：<code>/oauth/authorize</code></li></ul></li> <li><p>通过 POST 请求利用授权码访问认证服务器获取令牌</p> <ul><li>端点：<code>/oauth/token</code></li></ul></li></ul> <p><strong>附：默认的端点 URL</strong></p> <ul><li><code>/oauth/authorize</code>：授权端点</li> <li><code>/oauth/token</code>：令牌端点</li> <li><code>/oauth/confirm_access</code>：用户确认授权提交端点</li> <li><code>/oauth/error</code>：授权服务错误信息端点</li> <li><code>/oauth/check_token</code>：用于资源服务访问的令牌解析端点</li> <li><code>/oauth/token_key</code>：提供公有密匙的端点，如果你使用 JWT 令牌的话</li></ul> <h4 id="配置认证服务器"><a href="#配置认证服务器" class="header-anchor">#</a> 配置认证服务器</h4> <p>创建一个类继承 <code>AuthorizationServerConfigurerAdapter</code> 并添加相关注解：</p> <ul><li><code>@Configuration</code></li> <li><code>@EnableAuthorizationServer</code></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>pyy<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">ClientDetailsServiceConfigurer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerConfigurerAdapter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableAuthorizationServer</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 认证服务器配置
 * @author panyangyang
 * @date 2021-08-01 16:44
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        clients
                <span class="token comment">// 使用内存配置</span>
                <span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// client_id</span>
                <span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">&quot;client_id&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// client_secret</span>
                <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span><span class="token string">&quot;client_secret&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// 授权类型</span>
                <span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">&quot;authorization_code&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// 授权范围</span>
                <span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// 注册回调地址</span>
                <span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">&quot;http://www.xxx.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><h4 id="服务器安全配置"><a href="#服务器安全配置" class="header-anchor">#</a> 服务器安全配置</h4> <p>创建一个类继承 <code>WebSecurityConfigurerAdapter</code> 并添加相关注解：</p> <ul><li><code>@Configuration</code></li> <li><code>@EnableWebSecurity</code></li> <li><code>@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true, jsr250Enabled = true)</code>：全局方法拦截</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>pyy<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManagerBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>method<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableGlobalMethodSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableWebSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 服务器安全配置
 *
 * @author panyangyang
 * @date 2021-08-01 16:52
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token comment">/** Spring Security默认是禁用注解的，要想开启注解：判断用户对某个控制层的方法是否具有访问权限 */</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> jsr250Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">&quot;ADMIN&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="application-yaml"><a href="#application-yaml" class="header-anchor">#</a> application.yaml</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>server
  <span class="token key atrule">security</span><span class="token punctuation">:</span>
    <span class="token key atrule">user</span><span class="token punctuation">:</span>
      <span class="token comment"># 账号</span>
      <span class="token key atrule">name</span><span class="token punctuation">:</span> root
      <span class="token comment"># 密码</span>
      <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre></div><h4 id="访问获取授权码"><a href="#访问获取授权码" class="header-anchor">#</a> 访问获取授权码</h4> <p>打开浏览器，输入地址：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">http:</span>//localhost:8080/oauth/authorize?client_id=client&amp;response_type=code
</code></pre></div><p>第一次访问会跳转到登录页面</p> <p><img src="/study/assets/img/image-20210801170430803.2ef19634.png" alt="image-20210801170430803"></p> <p>输入 admin 123456 登录，会发现后台报错：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span></span>IllegalArgumentException</span><span class="token operator">:</span> <span class="token class-name">There</span> is no <span class="token class-name">PasswordEncoder</span> mapped <span class="token keyword">for</span> the id <span class="token string">&quot;null&quot;</span>
	at <span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>password<span class="token punctuation">.</span></span>DelegatingPasswordEncoder</span>$<span class="token class-name">UnmappedIdPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">matches</span><span class="token punctuation">(</span><span class="token class-name">DelegatingPasswordEncoder</span><span class="token punctuation">.</span>java<span class="token operator">:</span><span class="token number">244</span><span class="token punctuation">)</span> <span class="token operator">~</span><span class="token punctuation">[</span>spring<span class="token operator">-</span>security<span class="token operator">-</span>crypto<span class="token operator">-</span><span class="token number">5.1</span><span class="token number">.5</span><span class="token punctuation">.</span>RELEASE<span class="token punctuation">.</span>jar<span class="token operator">:</span><span class="token number">5.1</span><span class="token number">.5</span><span class="token punctuation">.</span>RELEASE<span class="token punctuation">]</span>
</code></pre></div><p>原因是因为在2.1之后的SpringSecurityOauth2版本中默认不允许使用明文登录，要求必须对密码加密，默认使用加密方式 <code>BCryptPasswordEncoder</code>:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">PasswordEncoderFactories</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token class-name">PasswordEncoder</span> <span class="token function">createDelegatingPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">String</span> encodingId <span class="token operator">=</span> <span class="token string">&quot;bcrypt&quot;</span><span class="token punctuation">;</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">PasswordEncoder</span><span class="token punctuation">&gt;</span></span> encoders <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>encodingId<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;ldap&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">LdapShaPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;MD4&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Md4PasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;MD5&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageDigestPasswordEncoder</span><span class="token punctuation">(</span><span class="token string">&quot;MD5&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;noop&quot;</span><span class="token punctuation">,</span> <span class="token class-name">NoOpPasswordEncoder</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;pbkdf2&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Pbkdf2PasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;scrypt&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">SCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;SHA-1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageDigestPasswordEncoder</span><span class="token punctuation">(</span><span class="token string">&quot;SHA-1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;SHA-256&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MessageDigestPasswordEncoder</span><span class="token punctuation">(</span><span class="token string">&quot;SHA-256&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        encoders<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token string">&quot;sha256&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">StandardPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DelegatingPasswordEncoder</span><span class="token punctuation">(</span>encodingId<span class="token punctuation">,</span> encoders<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token class-name">PasswordEncoderFactories</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>修改后：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 服务器安全配置
 *
 * @author panyangyang
 * @date 2021-08-01 16:52
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token comment">/** Spring Security默认是禁用注解的，要想开启注解：判断用户对某个控制层的方法是否具有访问权限 */</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> jsr250Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">BCryptPasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">PasswordEncoderFactories</span><span class="token punctuation">.</span><span class="token function">createDelegatingPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">&quot;ADMIN&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
 * 认证服务器配置
 * @author panyangyang
 * @date 2021-08-01 16:44
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Resource</span>
    <span class="token keyword">private</span>  <span class="token class-name">BCryptPasswordEncoder</span> passwordEncoder<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        clients
                <span class="token comment">// 使用内存配置</span>
                <span class="token punctuation">.</span><span class="token function">inMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token comment">// client_id</span>
                <span class="token punctuation">.</span><span class="token function">withClient</span><span class="token punctuation">(</span><span class="token string">&quot;client&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// client_secret</span>
                <span class="token punctuation">.</span><span class="token function">secret</span><span class="token punctuation">(</span>passwordEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;secret&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token comment">// 授权类型</span>
                <span class="token punctuation">.</span><span class="token function">authorizedGrantTypes</span><span class="token punctuation">(</span><span class="token string">&quot;authorization_code&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// 授权范围</span>
                <span class="token punctuation">.</span><span class="token function">scopes</span><span class="token punctuation">(</span><span class="token string">&quot;app&quot;</span><span class="token punctuation">)</span>
                <span class="token comment">// 注册回调地址</span>
                <span class="token punctuation">.</span><span class="token function">redirectUris</span><span class="token punctuation">(</span><span class="token string">&quot;http://localhost:8080/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>验证成功后会询问用户是否授权客户端</p> <p><img src="/study/assets/img/image-20210801171654520.45646c3e.png" alt="image-20210801171654520"></p> <p>选择授权后会跳转到我的博客，浏览器地址上还会包含一个授权码（<code>code=1JuO6V</code>），浏览器地址栏会显示如下地址：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">http:</span>//www.xxx.com/?code=GmtaGH
</code></pre></div><p>有了这个授权码就可以获取访问令牌了</p> <h4 id="通过授权码向服务器申请令牌"><a href="#通过授权码向服务器申请令牌" class="header-anchor">#</a> 通过授权码向服务器申请令牌</h4> <p>通过 CURL 或是 Postman 请求</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> -X POST -H <span class="token string">&quot;Content-Type: application/x-www-form-urlencoded&quot;</span> -d <span class="token string">'grant_type=authorization_code&amp;code=1JuO6V'</span> <span class="token string">&quot;http://client:secret@localhost:8080/oauth/token&quot;</span>
</code></pre></div><p><img src="/study/assets/img/image-20210801172808329.b22288ae.png" alt="image-20210801172808329"></p> <h3 id="基于-jdbc-存储令牌"><a href="#基于-jdbc-存储令牌" class="header-anchor">#</a> 基于 JDBC 存储令牌</h3> <h4 id="概述-2"><a href="#概述-2" class="header-anchor">#</a> 概述</h4> <p><strong>基于 JDBC 存储令牌</strong> 的模式用于演示最基本的操作，帮助大家快速理解 oAuth2 认证服务器中 &quot;认证&quot;、&quot;授权&quot;、&quot;访问令牌” 的基本概念</p> <p>操作流程：</p> <p><img src="/study/assets/img/image-20210801164133696-7827561.87a44181.png" alt="image-20210801164133696"></p> <ul><li>初始化 oAuth2 相关表</li> <li>在数据库中配置客户端</li> <li>配置认证服务器
<ul><li>配置数据源：<code>DataSource</code></li> <li>配置令牌存储方式：<code>TokenStore</code> -&gt; <code>JdbcTokenStore</code></li> <li>配置客户端读取方式：<code>ClientDetailsService</code> -&gt; <code>JdbcClientDetailsService</code></li> <li>配置服务端点信息：<code>AuthorizationServerEndpointsConfigurer</code> <ul><li><code>tokenStore</code>：设置令牌存储方式</li></ul></li> <li>配置客户端信息：<code>ClientDetailsServiceConfigurer</code> <ul><li><code>withClientDetails</code>：设置客户端配置读取方式</li></ul></li></ul></li> <li>配置 Web 安全
<ul><li>配置密码加密方式：<code>BCryptPasswordEncoder</code></li> <li>配置认证信息：<code>AuthenticationManagerBuilder</code></li></ul></li> <li>通过 GET 请求访问认证服务器获取授权码
<ul><li>端点：<code>/oauth/authorize</code></li></ul></li> <li>通过 POST 请求利用授权码访问认证服务器获取令牌
<ul><li>端点：<code>/oauth/token</code></li></ul></li></ul> <p><strong>附：默认的端点 URL</strong></p> <ul><li><code>/oauth/authorize</code>：授权端点</li> <li><code>/oauth/token</code>：令牌端点</li> <li><code>/oauth/confirm_access</code>：用户确认授权提交端点</li> <li><code>/oauth/error</code>：授权服务错误信息端点</li> <li><code>/oauth/check_token</code>：用于资源服务访问的令牌解析端点</li> <li><code>/oauth/token_key</code>：提供公有密匙的端点，如果你使用 JWT 令牌的话</li></ul> <h4 id="初始化-oauth2-相关表"><a href="#初始化-oauth2-相关表" class="header-anchor">#</a> 初始化 oAuth2 相关表</h4> <p>使用官方提供的建表脚本初始化 oAuth2 相关表，地址如下：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">https:</span>//github.com/spring-projects/spring-security-oauth/blob/master/spring-security-oauth2/src/test/resources/schema.sql
</code></pre></div><p>由于我们使用的是 MySQL 数据库，默认建表语句中主键为 <code>VARCHAR(256)</code>，这超过了最大的主键长度，请手动修改为 <code>128</code>，并用 <code>BLOB</code> 替换语句中的 <code>LONGVARBINARY</code> 类型，修改后的建表脚本如下：</p> <div class="language-sql extra-class"><pre class="language-sql"><code><span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>clientdetails<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>appId<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>resourceIds<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>appSecret<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>scope<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>grantTypes<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>redirectUrl<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authorities<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>access_token_validity<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>refresh_token_validity<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>additionalInformation<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>autoApproveScopes<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>appId<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>oauth_access_token<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>token_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>token<span class="token punctuation">`</span> <span class="token keyword">blob</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authentication_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>user_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>client_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authentication<span class="token punctuation">`</span> <span class="token keyword">blob</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>refresh_token<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>authentication_id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>oauth_approvals<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>userId<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>clientId<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>scope<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span><span class="token keyword">status</span><span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>expiresAt<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>lastModifiedAt<span class="token punctuation">`</span> <span class="token keyword">timestamp</span> <span class="token boolean">NULL</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>oauth_client_details<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>client_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>resource_ids<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>client_secret<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>scope<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authorized_grant_types<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>web_server_redirect_uri<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authorities<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>access_token_validity<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>refresh_token_validity<span class="token punctuation">`</span> <span class="token keyword">int</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>additional_information<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">4096</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>autoapprove<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>client_id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>oauth_client_token<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>token_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>token<span class="token punctuation">`</span> <span class="token keyword">blob</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authentication_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">NOT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>user_name<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>client_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token keyword">PRIMARY</span> <span class="token keyword">KEY</span> <span class="token punctuation">(</span><span class="token punctuation">`</span>authentication_id<span class="token punctuation">`</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>oauth_code<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>code<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authentication<span class="token punctuation">`</span> <span class="token keyword">blob</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>

<span class="token keyword">CREATE</span> <span class="token keyword">TABLE</span> <span class="token punctuation">`</span>oauth_refresh_token<span class="token punctuation">`</span> <span class="token punctuation">(</span>
  <span class="token punctuation">`</span>token_id<span class="token punctuation">`</span> <span class="token keyword">varchar</span><span class="token punctuation">(</span><span class="token number">256</span><span class="token punctuation">)</span> <span class="token keyword">DEFAULT</span> <span class="token boolean">NULL</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>token<span class="token punctuation">`</span> <span class="token keyword">blob</span><span class="token punctuation">,</span>
  <span class="token punctuation">`</span>authentication<span class="token punctuation">`</span> <span class="token keyword">blob</span>
<span class="token punctuation">)</span> <span class="token keyword">ENGINE</span><span class="token operator">=</span><span class="token keyword">InnoDB</span> <span class="token keyword">DEFAULT</span> <span class="token keyword">CHARSET</span><span class="token operator">=</span>utf8<span class="token punctuation">;</span>
</code></pre></div><h4 id="在数据库中配置客户端"><a href="#在数据库中配置客户端" class="header-anchor">#</a> 在数据库中配置客户端</h4> <p>在表 <code>oauth_client_details</code> 中增加一条客户端配置记录，需要设置的字段如下：</p> <ul><li><code>client_id</code>：客户端标识</li> <li><code>client_secret</code>：客户端安全码，<strong>此处不能是明文，需要加密</strong></li> <li><code>scope</code>：客户端授权范围</li> <li><code>authorized_grant_types</code>：客户端授权类型</li> <li><code>web_server_redirect_uri</code>：服务器回调地址</li></ul> <p>使用 <code>BCryptPasswordEncoder</code> 为客户端安全码加密，代码如下：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;secret&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>数据库配置客户端效果图如下：</p> <p><img src="/study/assets/img/image-20210801222752952.4f2f49b8.png" alt="image-20210801222752952"></p> <h4 id="pom依赖"><a href="#pom依赖" class="header-anchor">#</a> POM依赖</h4> <p>将下面pom依赖添加到 <code>spring-security-oauth2-dependencies</code></p> <p>由于使用了 JDBC 存储，我们需要增加相关依赖，数据库连接池部分弃用 <code>Druid</code> 改为 <code>HikariCP</code> （<strong>号称全球最快连接池</strong>）</p> <div class="language-xml extra-class"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>com.zaxxer<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>HikariCP<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${hikaricp.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusions</span><span class="token punctuation">&gt;</span></span>
        <span class="token comment">&lt;!-- 排除 tomcat-jdbc 以使用 HikariCP --&gt;</span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>exclusion</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.tomcat<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>tomcat-jdbc<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusion</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>exclusions</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>mysql<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>mysql-connector-java<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>${mysql.version}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h4 id="配置认证服务器-2"><a href="#配置认证服务器-2" class="header-anchor">#</a> 配置认证服务器</h4> <p>创建一个类继承 <code>AuthorizationServerConfigurerAdapter</code> 并添加相关注解：</p> <ul><li><code>@Configuration</code></li> <li><code>@EnableAuthorizationServer</code></li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>pyy<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>beans<span class="token punctuation">.</span>factory<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Autowired</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>context<span class="token punctuation">.</span>properties<span class="token punctuation">.</span></span><span class="token class-name">ConfigurationProperties</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>boot<span class="token punctuation">.</span>jdbc<span class="token punctuation">.</span></span><span class="token class-name">DataSourceBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Primary</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">ClientDetailsServiceConfigurer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerConfigurerAdapter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableAuthorizationServer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configurers<span class="token punctuation">.</span></span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span></span><span class="token class-name">ClientDetailsService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>client<span class="token punctuation">.</span></span><span class="token class-name">JdbcClientDetailsService</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span></span><span class="token class-name">TokenStore</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>provider<span class="token punctuation">.</span>token<span class="token punctuation">.</span>store<span class="token punctuation">.</span></span><span class="token class-name">JdbcTokenStore</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Resource</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">javax<span class="token punctuation">.</span>sql<span class="token punctuation">.</span></span><span class="token class-name">DataSource</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 认证服务器配置
 * @author panyangyang
 * @date 2021-08-01 16:44
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableAuthorizationServer</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AuthorizationServerConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">AuthorizationServerConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token annotation punctuation">@Primary</span>
    <span class="token annotation punctuation">@ConfigurationProperties</span><span class="token punctuation">(</span>prefix <span class="token operator">=</span> <span class="token string">&quot;spring.datasource&quot;</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token class-name">DataSource</span> <span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 配置数据源（注意，我使用的是 HikariCP 连接池），以上注解是指定数据源，否则会有冲突</span>
        <span class="token keyword">return</span> <span class="token class-name">DataSourceBuilder</span><span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">TokenStore</span> <span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 基于 JDBC 实现，令牌保存到数据</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcTokenStore</span><span class="token punctuation">(</span><span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">ClientDetailsService</span> <span class="token function">jdbcClientDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 基于 JDBC 实现，需要事先在数据库配置客户端信息</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">JdbcClientDetailsService</span><span class="token punctuation">(</span><span class="token function">dataSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthorizationServerEndpointsConfigurer</span> endpoints<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 设置令牌</span>
        endpoints<span class="token punctuation">.</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token function">tokenStore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">ClientDetailsServiceConfigurer</span> clients<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 读取客户端配置</span>
        clients<span class="token punctuation">.</span><span class="token function">withClientDetails</span><span class="token punctuation">(</span><span class="token function">jdbcClientDetails</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="服务器安全配置-2"><a href="#服务器安全配置-2" class="header-anchor">#</a> 服务器安全配置</h4> <p>创建一个类继承 <code>WebSecurityConfigurerAdapter</code> 并添加相关注解：</p> <ul><li><code>@Configuration</code></li> <li><code>@EnableWebSecurity</code></li> <li><code>@EnableGlobalMethodSecurity(prePostEnabled = true, securedEnabled = true, jsr250Enabled = true)</code>：全局方法拦截</li></ul> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>pyy<span class="token punctuation">.</span>oauth2<span class="token punctuation">.</span>config</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Bean</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>context<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span></span><span class="token class-name">Configuration</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>authentication<span class="token punctuation">.</span>builders<span class="token punctuation">.</span></span><span class="token class-name">AuthenticationManagerBuilder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>method<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableGlobalMethodSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">EnableWebSecurity</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>config<span class="token punctuation">.</span>annotation<span class="token punctuation">.</span>web<span class="token punctuation">.</span>configuration<span class="token punctuation">.</span></span><span class="token class-name">WebSecurityConfigurerAdapter</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>bcrypt<span class="token punctuation">.</span></span><span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>security<span class="token punctuation">.</span>crypto<span class="token punctuation">.</span>factory<span class="token punctuation">.</span></span><span class="token class-name">PasswordEncoderFactories</span><span class="token punctuation">;</span>

<span class="token comment">/**
 * 服务器安全配置
 *
 * @author panyangyang
 * @date 2021-08-01 16:52
 */</span>
<span class="token annotation punctuation">@Configuration</span>
<span class="token annotation punctuation">@EnableWebSecurity</span>
<span class="token comment">/** Spring Security默认是禁用注解的，要想开启注解：判断用户对某个控制层的方法是否具有访问权限 */</span>
<span class="token annotation punctuation">@EnableGlobalMethodSecurity</span><span class="token punctuation">(</span>prePostEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> securedEnabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">,</span> jsr250Enabled <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">WebSecurityConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Bean</span>
    <span class="token keyword">public</span> <span class="token class-name">BCryptPasswordEncoder</span> <span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">BCryptPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">AuthenticationManagerBuilder</span> auth<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">PasswordEncoderFactories</span><span class="token punctuation">.</span><span class="token function">createDelegatingPasswordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


        auth<span class="token punctuation">.</span><span class="token function">inMemoryAuthentication</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">&quot;admin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">&quot;ADMIN&quot;</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                <span class="token punctuation">.</span><span class="token function">withUser</span><span class="token punctuation">(</span><span class="token string">&quot;user&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">password</span><span class="token punctuation">(</span><span class="token function">passwordEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token string">&quot;123456&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">roles</span><span class="token punctuation">(</span><span class="token string">&quot;USER&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="application-yml"><a href="#application-yml" class="header-anchor">#</a> application.yml</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">spring</span><span class="token punctuation">:</span>
  <span class="token key atrule">application</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> oauth2<span class="token punctuation">-</span>server
  <span class="token key atrule">datasource</span><span class="token punctuation">:</span>
    <span class="token key atrule">type</span><span class="token punctuation">:</span> com.zaxxer.hikari.HikariDataSource
    <span class="token key atrule">driver-class-name</span><span class="token punctuation">:</span> com.mysql.cj.jdbc.Driver
    <span class="token key atrule">jdbc-url</span><span class="token punctuation">:</span> jdbc<span class="token punctuation">:</span>mysql<span class="token punctuation">:</span>//localhost<span class="token punctuation">:</span>3306/oauth2<span class="token punctuation">?</span>useUnicode=true<span class="token important">&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=UTC</span>
    <span class="token key atrule">username</span><span class="token punctuation">:</span> root
    <span class="token key atrule">password</span><span class="token punctuation">:</span> <span class="token number">123456</span>
    <span class="token key atrule">hikari</span><span class="token punctuation">:</span>
      <span class="token key atrule">minimum-idle</span><span class="token punctuation">:</span> <span class="token number">5</span>
      <span class="token key atrule">idle-timeout</span><span class="token punctuation">:</span> <span class="token number">600000</span>
      <span class="token key atrule">maximum-pool-size</span><span class="token punctuation">:</span> <span class="token number">10</span>
      <span class="token key atrule">auto-commit</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
      <span class="token key atrule">pool-name</span><span class="token punctuation">:</span> MyHikariCP
      <span class="token key atrule">max-lifetime</span><span class="token punctuation">:</span> <span class="token number">1800000</span>
      <span class="token key atrule">connection-timeout</span><span class="token punctuation">:</span> <span class="token number">30000</span>
      <span class="token key atrule">connection-test-query</span><span class="token punctuation">:</span> SELECT 1

<span class="token key atrule">server</span><span class="token punctuation">:</span>
  <span class="token key atrule">port</span><span class="token punctuation">:</span> <span class="token number">8080</span>
</code></pre></div><h4 id="访问获取授权码-2"><a href="#访问获取授权码-2" class="header-anchor">#</a> 访问获取授权码</h4> <p>打开浏览器，输入地址：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">http:</span>//localhost:8080/oauth/authorize?client_id=client&amp;response_type=code
</code></pre></div><p>第一次访问会跳转到登录页面</p> <p><img src="/study/assets/img/image-20210801170430803.2ef19634.png" alt="image-20210801170430803"></p> <p>验证成功后会询问用户是否授权客户端</p> <p><img src="/study/assets/img/image-20210801171654520.45646c3e.png" alt="image-20210801171654520"></p> <p>选择授权后会跳转到我的博客，浏览器地址上还会包含一个授权码（<code>code=1JuO6V</code>），浏览器地址栏会显示如下地址：</p> <div class="language-http extra-class"><pre class="language-http"><code><span class="token header-name keyword">http:</span>//localhost:8080/?code=MZdjW3
</code></pre></div><p>有了这个授权码就可以获取访问令牌了</p> <h4 id="通过授权码向服务器申请令牌-2"><a href="#通过授权码向服务器申请令牌-2" class="header-anchor">#</a> 通过授权码向服务器申请令牌</h4> <p>通过 CURL 或是 Postman 请求</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">curl</span> -X POST -H <span class="token string">&quot;Content-Type: application/x-www-form-urlencoded&quot;</span> -d <span class="token string">'grant_type=authorization_code&amp;code=MZdjW3'</span> <span class="token string">&quot;http://client:secret@localhost:8080/oauth/token&quot;</span>
</code></pre></div><p>结果</p> <div class="language- extra-class"><pre class="language-text"><code>{&quot;access_token&quot;:&quot;32905a8e-8c7d-415f-9e29-5b608005f855&quot;,&quot;token_type&quot;:&quot;bearer&quot;,&quot;expires_in&quot;:43199,&quot;scope&quot;:&quot;app&quot;}%
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/study/javaji-shu-zhan/spring-boot.html" class="prev">
        SpringBoot 基础篇
      </a></span> <span class="next"><a href="/study/servicemesh/">
        介绍
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/study/assets/js/app.dc60e210.js" defer></script><script src="/study/assets/js/6.fceef279.js" defer></script><script src="/study/assets/js/14.48e59348.js" defer></script>
  </body>
</html>
